!function(e){function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}var t={};n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},n.p="",n(n.s=11)}([function(e,n){e.exports=require("log4js")},function(e,n){e.exports=require("bluebird")},function(e,n){e.exports=require("path")},function(e,n){e.exports=require("fs")},function(e,n,t){"use strict";n.msgServer=t(9).msgServer,n.msgClient=t(9).msgClient,n.deliver=t(27).deliver},function(e,n,t){"use strict";var r=(t(44),t(0)),o=r.getLogger("RedisIniter"),i=t(43),s=(t(1),void parseInt(process.env.SessionTimeOut));String.prototype.startWith=function(e){return new RegExp("^"+e).test(this)},String.prototype.endWith=function(e){return new RegExp(e+"$").test(this)},n.boot=function(){var e=t(8).getParams(process.env.RedisUrl);s=new i(e.port,e.host);var n=new i(e.port,e.host);s.on("ready",function(){o.info("Ready")}),n.on("ready",function(){n.psubscribe("__keyevent@0__:expired")}),s.on("connect",function(){o.info("connect")}),n.on("pmessage",function(e,n,t){if(t.startWith("serverso")){var r=t.substring(8,t.length);s.lrem("so:server",-1,r)}}),s.on("reconnect",function(){o.warn("reconnect")}),s.on("error",function(e){o.error("error "+e)})},n.client=function(){return s}},function(e,n){e.exports=require("mongoose")},function(e,n){e.exports={appStatus:{params:[{name:"info",type:"任意",des:"详细信息",necessary:!1}],_links:"/app/status",method:"GET",des:"服务器信息"},listinfo:{params:[],_links:"/app/listinfo",method:"GET",des:"显示api信息"},getLog:{params:[{name:"filename",type:"string",des:"日志文件名字",necessary:!1}],_links:"/app/getLog",method:"GET",des:"获取日志文件，beta"},queryOrderByDay:{params:[{name:"date",type:"string",des:"查询的时间"}],_links:"/order/query/day",method:"GET",des:"根据时间查询订单"},finishSend:{params:[{name:"order",type:"string",des:"订单id"}],_links:"/order/sended/:order",method:"GET",des:"标记完成订单"},queryOrderById:{params:[{name:"id",type:"string",des:"查询的用户id （openid）"}],_links:"/order/query/id",method:"GET",des:"根据时间查询订单"},order_notify:{params:[],_links:"/order_notify",method:"POST",des:"微信支付完成通知 生成一个支付完成的订单, 传入xml数据(https)"},ok_notify:{params:[{name:"out_trade_no",type:"string",des:"订单out_trade_no"}],_links:"/ok_notify/:out_trade_no",method:"GET",des:"商家确认订单(https)"}}},function(e,n,t){"use strict";n.getParams=function(e){if(!e)return{};var n=e.split(/:\/\/|:|@|\/|\?/);return{type:n[0],username:n[1],password:n[2],host:n[3],port:n[4],db:n[5],param:n[6]}}},function(e,n,t){"use strict";var r=t(6),o=r.Schema,i=new o({_id:{type:String},openid:{trpe:String},type:{type:Number},num:{type:Number},date:{type:Date},stat:{type:Number}}),s=new o({_id:{type:String},openid:{trpe:String},type:{type:Number},num:{type:Number},date:{type:Date},stat:{type:Number}});n.msgServer=r.model("msgServer",i),n.msgClient=r.model("msgClient",s)},function(e,n,t){"use strict";function r(){return i.find().then(function(e){return e&&e.forEach(function(e){console.log(e),n.NotifyServer(e,!0)}),!0}).error(function(e){return!1})}function o(e){return s.find({openid:e.id}).then(function(t){return t&&t.forEach(function(t){console.log(t),n.NotifyClient(t,e,!0)}),!0}).error(function(e){return!1})}var i=t(4).msgServer,s=t(4).msgClient,u=t(1),c={client:{},server:{}};n.AddServer=function(e){var n=e.id;n&&(c.server[n]?(c.server[n].disconnect(!0),c.server[n]=e):c.server[n]=e,r())},n.AddClient=function(e){var n=e.id;n&&(c.client[n]?(c.client[n].disconnect(!0),c.client[n]=e):c.client[n]=e,o(e))},n.DelServer=function(e){delete c.server[e.id]},n.DelClient=function(e){delete c.client[e.id]},n.NotifyClient=function(e,n,t){return t?new u(function(t){var r=void 0;if(n)r=n;else{var o=e.openid;r=c.client[o]}r&&r.sendUTF(JSON.stringify({type:"cnotify",data:e})),t(!0)}):new s(e).save().then(function(t){if(t){var r=void 0;if(n)r=n;else{var o=e.openid;r=c.client[o]}return r&&r.sendUTF(JSON.stringify({type:"cnotify",data:e})),!0}return!1}).error(function(e){return!1})},n.NotifyServer=function(e,n){return console.log("no server"),n?new u(function(n){var t=c.server;console.log("servers:"+t);for(key in t)console.log(JSON.stringify({type:"snotify",data:e})),t[key].sendUTF(JSON.stringify({type:"snotify",data:e}));n(!0)}):(console.log("save:"+JSON.stringify(e)+e._id),new i(e).save().then(function(n){if(console.log("ok:"+n),n){var t=c.server;console.log("servers:"+t);for(key in t)console.log(JSON.stringify({type:"snotify",data:e})),t[key].sendUTF(JSON.stringify({type:"snotify",data:e}));return!0}return!1}).error(function(e){return!1}))},n.NotifyResponse=function(e,n){"ok_snotify"===e?i.remove({_id:n._id}):"ok_cnotify"===e&&s.remove({_id:n._id})}},function(e,n,t){"use strict";var r=t(16),o=t(2);t(13).boot(o.resolve("./etc"),o.resolve("../etc"));var i=t(15),s=t(14);if(r.isMaster){console.log(" Fork %s worker(s) from master",1);for(var u=0;u<1;u++)r.fork();r.on("online",function(e){console.log("worker is running on %s pid",e.process.pid)}),r.on("exit",function(e,n,t){console.log("worker with %s is closed",e.process.pid)})}else r.isWorker&&(console.log("worker (%s) is running",r.worker.process.pid),i.boot());r.on("death",function(e){console.log("worker "+e.pid+" died. restart..."),r.fork()});var c=t(3),a=o.join(process.cwd(),"runtime","lock");if(!function(e){try{c.accessSync(e,c.F_OK)}catch(e){return!1}return!0}(a)){var d=c.createWriteStream(a);d.write("lock"),d.end(),s.RegisterTask()}},function(e,n){e.exports=require("moment")},function(e,n,t){"use strict";var r=t(18),o=t(19);n.boot=function(e,n){r.boot(e,n),o.boot()}},function(e,n,t){"use strict";n.RegisterTask=t(28).RegisterTask},function(e,n,t){"use strict";(function(e){function r(){"test"!==v.get("env")&&S.listen(h,function(){s.info("服务器端口："+h)})}function o(){S.close()}var i=t(0),s=i.getLogger("server"),u=t(40),c=t(41),a=(t(2),t(35));t(36)(a);var d=t(38),f=t(1),p=(f.promisifyAll(t(3)),t(7)),l=t(25),y=t(23),g=t(29),v=u();g.boot(v),v.use(a.urlencoded({extended:!0})),v.use(a.json()),v.use(a.xml({limit:"1MB",xmlParseOptions:{normalize:!0,normalizeTags:!0,explicitArray:!1}})),v.use(d());var m=t(39);v.use(m()),y.boot(v),l.boot(),v.all("*",function(e,n){n.status(404).json({code:404,msg:"没有此Api",_links:p})}),v.use(function(e,n,t,r){return"UnauthorizedError"===e.name?void t.status(401).json({code:401,errCode:401e3,msg:"未许可Api"}):t.headersSent?r(e):(t.status(500),void t.json({code:500,msg:"发生未知错误",_links:p}))});var h=process.env.PORT||3e3,S=c.createServer(v);t(32).init(S),S.on("error",function(e){s.error(e)}),process.on("uncaughtException",function(e){s.error(e),s.error(e.stack)}),n.app=v,n.boot=r,n.shutdown=o,n.port=h,t.c[t.s]===e?t(11):console.log("Running app as a module")}).call(n,t(33)(e))},function(e,n){e.exports=require("cluster")},function(e,n,t){"use strict";var r=process.env,o=t(1),i=o.promisifyAll(t(3)),s=t(2),u=function(e){try{i.accessSync(e,i.F_OK)}catch(e){return!1}return!0},c=function(e){if(u(e)){var n=i.readFileSync(e,"utf8");if(n){var t=JSON.parse(n);a(r,"",t)}}},a=function e(n,t,r){if(r instanceof Array)n[t]=r;else if(r instanceof Object)for(var o in r)e(n,t+o,r[o]);else n[t]=r};n.ENVSET=function(e,n){e&&(c(s.join(e,"project.json")),c(s.join(e,"db.json")),c(s.join(e,"cluster.json"))),n&&(c(s.join(n,"project.json")),c(s.join(n,"db.json")),c(s.join(n,"cluster.json"))),"production"===process.env.model&&(e&&(c(s.join(e,"production","project.json")),c(s.join(e,"production","db.json")),c(s.join(e,"production","cluster.json"))),n&&(c(s.join(n,"production","project.json")),c(s.join(n,"production","db.json")),c(s.join(n,"production","cluster.json"))))}},function(e,n,t){"use strict";var r=t(17);n.boot=function(e,n){r.ENVSET(e,n)}},function(e,n,t){"use strict";var r=t(20);n.boot=function(){r.set()}},function(e,n,t){"use strict";var r=t(2),o=process.env.name;o=o||"app";var i=r.join(process.cwd(),"logs",o),s={appenders:{STDOUT:{type:"stdout",layout:{type:"ENCODER_PATTERN",separator:","},filter:{level:"error"}},FILE:{type:"dateFile",filename:r.join(i,"common"),pattern:"_yyyy-MM-dd.log",compress:!0,alwaysIncludePattern:!0,layout:{type:"ENCODER_PATTERN",separator:","}},error:{type:"dateFile",filename:r.join(i,"error"),pattern:"_yyyy-MM-dd.log",compress:!0,alwaysIncludePattern:!0,levelFilter:{level:"error"},layout:{type:"ENCODER_PATTERN",separator:","}},ERROR_FILE:{type:"logLevelFilter",appender:"error",level:"error"}},categories:{default:{appenders:["STDOUT","FILE","ERROR_FILE"],level:"info"}}},u=t(12);n.set=function(){var e=t(0);e.addLayout("ENCODER_PATTERN",function(e){return function(e){return u(e.startTime).format("YYYY-MM-DD HH:MM:ss.SSS")+" [main] "+e.level.levelStr+" "+e.categoryName+" - "+e.data}}),e.configure(s)}},function(e,n,t){"use strict";var r=t(0),o=r.getLogger("ControllerApp"),i=t(46),s=t(37).exec,u=t(34),c=new Date,a=t(2),d=t(1),f=d.promisifyAll(t(3));n.status=function(e,n){o.info("Status Api Call");var t=e.app;if(e.query.info){var r={};u.parallel([function(e){s("netstat -an | grep :80 | wc -l",function(n,t){r[80]=parseInt(t,10),e()})},function(e){s("netstat -an | grep :"+t.set("port")+" | wc -l",function(n,o){r[t.set("port")]=parseInt(o,10),e()})}],function(e){n.json({status:"up",version:t.get("version"),sha:t.get("git sha"),started_at:c,node:{version:process.version,memory:Math.round(process.memoryUsage().rss/1024/1024)+"M",uptime:process.uptime()},system:{loadavg:i.loadavg(),freeMemory:Math.round(i.freemem()/1024/1024)+"M"},env:"production",hostname:i.hostname(),connections:r,swap:void 0})})}else n.json({status:"up"})};var p=t(7),l={code:0,data:p,model:process.env.model,PVersion:process.env.PVersion,state:process.env.state};n.listinfo=function(e,n){return n.status(200).json(l)};var y=function(e){return f.accessAsync(e,f.F_OK).then(function(e){return!0},function(e){return!1})},g=function(e){return f.readFileAsync(e,"utf8").then(function(e){if(e)return e})},v=function(e,n){var t=a.join(process.cwd(),"runtime","logs",e);y(t).then(function(e){return e?g(t).then(function(e){return e?n.status(200).json({code:0,data:e}):n.status(200).json({code:1})}):n.status(200).json({code:1})})};n.getLog=function(e,n){o.info("getLog api call"),e.query.filename?v(e.query.filename,n):v("latest.log",n)}},function(e,n,t){"use strict";var r=t(0),o=r.getLogger("ControllerDeliver");n.queryByDay=function(e,n){o.info("queryByDay Api Call");var t=e.query.date;e.models.queryorder.queryByDay(t).then(function(e){return n.status(200).send(e)}).error(function(e){return n.status(200).send(NotifyError)})},n.finishSend=function(e,n){o.info("finishSend Api Call");var t=e.params.order;e.models.queryorder.finishSend(t).then(function(e){return n.status(200).send(e)}).error(function(e){return n.status(200).send(NotifyError)})},n.queryById=function(e,n){o.info("queryById Api Call");var t=e.query.id;e.models.queryorder.queryById(t).then(function(e){return n.status(200).send(e)}).error(function(e){return n.status(200).send(NotifyError)})}},function(e,n,t){"use strict";var r=t(21),o=t(22),i=t(24);n.boot=function(e){e.get("/app/status",r.status),e.get("/app/listinfo",r.listinfo),e.get("/app/getLog",r.getLog),e.get("/order/query/day",o.queryByDay),e.get("/order/sended/:order",o.finishSend),e.get("/order/query/id",o.queryById),e.post("/order_notify",i.orderNotify),e.get("/ok_notify/:out_trade_no",i.ok_notify)}},function(e,n,t){"use strict";var r=t(0),o=r.getLogger("ControllerSocketServer");n.orderNotify=function(e,n){o.info("order receive Notify Api Call");var t=e.body;console.log(t),e.models.notify.WXPaySuccess(t).then(function(e){return n.status(200).send(e)}).error(function(e){return n.status(200).send("<xml><return_code>FAIL</return_code><return_msg>支付通知失败</return_msg></xml>")})},n.ok_notify=function(e,n){o.info("ok_notify Api Call");var t=e.params.out_trade_no;if(!t)return n.status(200).json({code:1,msg:"参数错误-1"});e.models.notify.SaveAndNotifyOrder(t).then(function(e){return e?n.status(200).json(e):n.status(200).json({code:1,msg:"unknown-1"})}).error(function(e){return n.status(200).json({code:1,msg:"unknown-2"})})}},function(e,n,t){"use strict";n.boot=function(){t(26).boot(),t(5).boot()}},function(e,n,t){"use strict";var r=t(0),o=r.getLogger("MongoseIniter"),i=(t(1),t(6));i.Promise=t(1),n.boot=function(){var e=t(8).getParams(process.env.MongoUrl),n="mongodb://127.0.0.1:27017";e.host&&e.port&&(n="mongodb://"+e.host+":"+e.port);var r={useMongoClient:!0};i.connect(n+"/"+(e.db||"template"),r);var s=i.connection;s.on("error",function(e){o.error(e)}),s.once("open",function(){o.info("MongoDB open:"+e.db)})}},function(e,n,t){"use strict";var r=t(6),o=r.Schema,i=new o({_id:{type:String},openid:{trpe:String},type:{type:Number},num:{type:Number},date:{type:Date},stat:{type:Number}});n.deliver=r.model("deliver",i)},function(e,n,t){"use strict";function r(){var e=0;o.scheduleJob("*/1 * * * * *",function(){if(e+6e4<Date.now()){e=Date.now();var n=encodeURIComponent(process.env.Address),t=encodeURIComponent(process.env.name),r=encodeURIComponent(process.env.desc);u("http://"+process.env.Register+"/register/register?address="+n+"&name="+t+"&desc="+r,"GET",function(o,i,u,c){if(o||!i)return e=0,void s.error("Failure",o);var a="";try{a=JSON.parse(i)}catch(n){e=0,console.log(i)}o||!a||0==!a.code?(e=0,s.error("no register server at:http://"+process.env.Register+"/register/register?address="+n+"&name="+t+"&desc="+r)):s.info("register succeed at time:"+new Date)})}})}var o=t(45),i=t(0),s=i.getLogger("Task"),u=t(42);t(5),n.RegisterTask=function(){r()}},function(e,n,t){"use strict";var r=t(30),o=t(31),i={notify:r,queryorder:o};n.boot=function(e){e.use(function(e,n,t){return e.models=i,t()})}},function(e,n,t){"use strict";function r(){return{_id:"trade_no-mock"+t(47).v1(),openid:"openid-mock",type:0,num:2,date:Date.now(),stat:2}}var o=t(0),i=(o.getLogger("ServiceNotify"),t(1)),s=t(4).deliver,u=t(5),c=t(10),a="<xml><return_code>FAIL</return_code><return_msg>支付通知失败</return_msg></xml>";n.WXPaySuccess=function(e){var n=e.xml;if(n&&"SUCCESS"===n.return_code&&"SUCCESS"===n.result_code&&n.out_trade_no){var t=n.out_trade_no,o="dw:pre:order:"+t;return u.client().get(o).then(function(e){var n=JSON.parse(e);return c.NotifyServer(r()),n?(n.stat=2,u.client().set("dw:paied:order:"+t,JSON.stringify(n)).then(function(e){return"OK"===e?(u.client().expire(o,0),u.client().del(o),c.NotifyServer(n).then(function(e){return e?"<xml><return_code>SUCCESS</return_code><return_msg>OK</return_msg></xml>":a})):a})):a}).error(function(e){return a})}return new i(function(e){e(a)})},n.SaveAndNotifyOrder=function(e){var n="dw:paied:order:"+e;return u.client().get(n).then(function(e){try{var n=JSON.parse(e);return n.stat=1,console.log(n),new s(n).save().then(function(e){return e?{code:0,order:n}:{code:1,msg:"保存订单数据出错"}})}catch(e){return{code:1,msg:"订单数据错误"}}}).then(function(e){return 0===e.code?u.client().del(n).then(function(n){return c.NotifyClient(e.order).then(function(e){return e?{code:0}:{code:1,msg:"处理出错001"}})}):e}).error(function(e){return{code:1,msg:"unknown",err:e}})}},function(e,n,t){"use strict";var r=t(4).deliver,o=t(12);n.queryByDay=function(e){var n=Date.now();try{var t=parseInt(e);t=new Date(t),n=t}catch(e){console.log("error when parse date")}var i=new Date(o(n).format("YYYY/MM/DD"));return console.log(o(i)),r.find({date:{$gte:i}}).then(function(e){return{code:0,data:e}}).error(function(e){return{code:1,msg:"查询出错-1"}})},n.queryById=function(e){return r.find({openid:e}).then(function(e){return{code:0,data:e}}).error(function(e){return{code:1,msg:"查询出错-1"}})},n.finishSend=function(e){return r.findOneAndUpdate({_id:e},{stat:0}).then(function(e){return{code:0}}).error(function(e){return{code:1,msg:"unknown-1"}})}},function(e,n,t){"use strict";var r=t(0),o=r.getLogger("SocketIniter"),i=t(48).server,s=t(10);n.init=function(e){new i({httpServer:e,autoAcceptConnections:!0}).on("connect",function(e){o.info("connect"),e.sendUTF(JSON.stringify({type:"echo",data:"echo data"})),e.on("message",function(n){if("utf8"===n.type)try{var t=JSON.parse(n.utf8Data),r=t.type;"slogin"===r?(o.info("slogin"),e.id=t.id,e.utype="server",s.AddServer(e),e.sendUTF(JSON.stringify({type:"ok_login"}))):"clogin"===r?(o.info("clogin"),e.id=t.id,e.utype="client",s.AddClient(e),e.sendUTF(JSON.stringify({type:"ok_login"}))):"ping"===r?(o.info("ping"),e.sendUTF(JSON.stringify({type:"ping",msg:"hb"}))):s.NotifyResponse(r,t.data)}catch(n){e.sendUTF(JSON.stringify({type:"err",msg:"not json text"}))}}).on("close",function(n,t){o.info("close"),"client"===e.utype?s.DelClient(e.id):s.DelServer(e.id)})})}},function(e,n){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,n){e.exports=require("async")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("body-parser-xml")},function(e,n){e.exports=require("child_process")},function(e,n){e.exports=require("cors")},function(e,n){e.exports=require("errorhandler")},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("http")},function(e,n){e.exports=require("httpinvoke")},function(e,n){e.exports=require("ioredis")},function(e,n){e.exports=require("lodash")},function(e,n){e.exports=require("node-schedule")},function(e,n){e.exports=require("os")},function(e,n){e.exports=require("uuid")},function(e,n){e.exports=require("websocket")}]);