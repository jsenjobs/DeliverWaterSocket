!function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=13)}([function(e,t){e.exports=require("log4js")},function(e,t){e.exports=require("bluebird")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs")},function(e,t,n){"use strict";t.msgServer=n(9).msgServer,t.msgClient=n(9).msgClient,t.userClient=n(10).userClient,t.userServer=n(10).userServer,t.deliver=n(29).deliver},function(e,t){e.exports=require("mongoose")},function(e,t,n){"use strict";var r=(n(47),n(0)),o=r.getLogger("RedisIniter"),i=n(46),s=(n(1),void parseInt(process.env.SessionTimeOut));String.prototype.startWith=function(e){return new RegExp("^"+e).test(this)},String.prototype.endWith=function(e){return new RegExp(e+"$").test(this)},t.boot=function(){var e=n(8).getParams(process.env.RedisUrl);s=new i(e.port,e.host);var t=new i(e.port,e.host);s.on("ready",function(){o.info("Ready")}),t.on("ready",function(){t.psubscribe("__keyevent@0__:expired")}),s.on("connect",function(){o.info("connect")}),t.on("pmessage",function(e,t,n){if(n.startWith("serverso")){var r=n.substring(8,n.length);s.lrem("so:server",-1,r)}}),s.on("reconnect",function(){o.warn("reconnect")}),s.on("error",function(e){o.error("error "+e)})},t.client=function(){return s}},function(e,t){e.exports={appStatus:{params:[{name:"info",type:"任意",des:"详细信息",necessary:!1}],_links:"/app/status",method:"GET",des:"服务器信息"},listinfo:{params:[],_links:"/app/listinfo",method:"GET",des:"显示api信息"},getLog:{params:[{name:"filename",type:"string",des:"日志文件名字",necessary:!1}],_links:"/app/getLog",method:"GET",des:"获取日志文件，beta"},order_notify:{params:[],_links:"/order_notify",method:"POST",des:"微信小程序支付完成通知 生成一个支付完成的订单, 传入xml数据(https)"},aliPayAsyncNotify:{params:[],_links:"/notify/ali/asyncpay",method:"POST",des:"异步通知 (https)"},wxPayAsyncNotify:{params:[],_links:"/notify/wx/asyncpay",method:"POST",des:"异步通知 (https)"},ok_notify:{params:[{name:"out_trade_no",type:"string",des:"订单out_trade_no"}],_links:"/ok_notify/:out_trade_no",method:"GET",des:"商家确认订单(https)"}}},function(e,t,n){"use strict";t.getParams=function(e){if(!e)return{};var t=e.split(/:\/\/|:|@|\/|\?/);return{type:t[0],username:t[1],password:t[2],host:t[3],port:t[4],db:t[5],param:t[6]}}},function(e,t,n){"use strict";var r=n(5),o=r.Schema,i=new o({_id:{type:String},openid:{trpe:String},type:{type:Number},num:{type:Number},date:{type:Date},fee:{type:String},platform:{type:String},stat:{type:Number}}),s=new o({_id:{type:String},openid:{trpe:String},type:{type:Number},num:{type:Number},date:{type:Date},fee:{type:String},platform:{type:String},stat:{type:Number}});t.msgServer=r.model("msgServer",i),t.msgClient=r.model("msgClient",s)},function(e,t,n){"use strict";var r=n(5),o=r.Schema,i=new o({_id:{type:String},password:{type:String},name:{type:String},address:{type:String},register_date:{type:Date},last_login:{type:Date}}),s=new o({_id:{type:String},password:{type:String},register_date:{type:Date},last_login:{type:Date}});t.userClient=r.model("userClient",i),t.userServer=r.model("userServer",s)},function(e,t,n){"use strict";t.AliPayUtils=n(33),t.WxPayUtils=n(34)},function(e,t,n){"use strict";function r(){return i.find().then(function(e){return e&&e.forEach(function(e){console.log(e),t.NotifyServer(e,!0)}),!0}).error(function(e){return!1})}function o(e){return s.find({openid:e.id}).then(function(n){return n&&n.forEach(function(n){console.log(n),t.NotifyClient(n,e,!0)}),!0}).error(function(e){return!1})}var i=n(4).msgServer,s=n(4).msgClient,c=n(1),u={client:{},server:{}};t.AddServer=function(e){var t=e.id;t&&(u.server[t]?(u.server[t].close(),u.server[t]=e):u.server[t]=e,r())},t.AddClient=function(e){var t=e.id;t&&(u.client[t]?(u.client[t].close(),u.client[t]=e):u.client[t]=e,o(e))},t.DelServer=function(e){delete u.server[e.id]},t.DelClient=function(e){delete u.client[e.id]},t.NotifyClient=function(e,t,n){return n?new c(function(n){var r=void 0;if(t)r=t;else{var o=e.openid;r=u.client[o]}r&&r.sendUTF(JSON.stringify({type:"cnotify",data:e})),n(!0)}):new s(e).save().then(function(n){if(n){var r=void 0;if(t)r=t;else{var o=e.openid;r=u.client[o]}return r&&r.sendUTF(JSON.stringify({type:"cnotify",data:e})),!0}return!1}).error(function(e){return!1})},t.NotifyServer=function(e,t){return console.log("no server"),t?new c(function(t){var n=u.server;console.log("servers:"+n);for(key in n)console.log(JSON.stringify({type:"snotify",data:e})),n[key].sendUTF(JSON.stringify({type:"snotify",data:e}));t(!0)}):(console.log("save:"+JSON.stringify(e)+e._id),new i(e).save().then(function(t){if(console.log("ok:"+t),t){var n=u.server;console.log("servers:"+n);for(key in n)console.log(JSON.stringify({type:"snotify",data:e})),n[key].sendUTF(JSON.stringify({type:"snotify",data:e}));return!0}return!1}).error(function(e){return!1}))},t.NotifyResponse=function(e,t){"ok_snotify"===e?i.remove({_id:t._id}):"ok_cnotify"===e&&s.remove({_id:t._id})}},function(e,t,n){"use strict";var r=n(18),o=n(2);n(15).boot(o.resolve("./etc"),o.resolve("../etc"));var i=n(17),s=n(16);if(r.isMaster){console.log(" Fork %s worker(s) from master",1);for(var c=0;c<1;c++)r.fork();r.on("online",function(e){console.log("worker is running on %s pid",e.process.pid)}),r.on("exit",function(e,t,n){console.log("worker with %s is closed",e.process.pid)})}else r.isWorker&&(console.log("worker (%s) is running",r.worker.process.pid),i.boot());r.on("death",function(e){console.log("worker "+e.pid+" died. restart..."),r.fork()});var u=n(3),a=o.join(process.cwd(),"runtime","lock");if(!function(e){try{u.accessSync(e,u.F_OK)}catch(e){return!1}return!0}(a)){var f=u.createWriteStream(a);f.write("lock"),f.end(),s.RegisterTask()}},function(e,t){e.exports=require("crypto")},function(e,t,n){"use strict";var r=n(20),o=n(21);t.boot=function(e,t){r.boot(e,t),o.boot()}},function(e,t,n){"use strict";t.RegisterTask=n(30).RegisterTask},function(e,t,n){"use strict";(function(e){function r(){"test"!==v.get("env")&&_.listen(S,function(){s.info("服务器端口："+S)})}function o(){_.close()}var i=n(0),s=i.getLogger("server"),c=n(43),u=n(44),a=(n(2),n(38));n(39)(a);var f=n(41),l=n(1),p=(l.promisifyAll(n(3)),n(7)),d=n(27),y=n(24),g=n(31),v=c();g.boot(v),v.use(a.urlencoded({extended:!0})),v.use(a.json()),v.use(a.xml({limit:"1MB",xmlParseOptions:{normalize:!0,normalizeTags:!0,explicitArray:!1}})),v.use(f());var m=n(42);v.use(m()),y.boot(v),d.boot(),v.all("*",function(e,t){t.status(404).json({code:404,msg:"没有此Api",_links:p})}),v.use(function(e,t,n,r){return"UnauthorizedError"===e.name?void n.status(401).json({code:401,errCode:401e3,msg:"未许可Api"}):n.headersSent?r(e):(n.status(500),void n.json({code:500,msg:"发生未知错误",_links:p}))});var S=process.env.PORT||3e3,_=u.createServer(v);n(35).init(_),_.on("error",function(e){s.error(e)}),process.on("uncaughtException",function(e){s.error(e),s.error(e.stack)}),t.app=v,t.boot=r,t.shutdown=o,t.port=S,n.c[n.s]===e?n(13):console.log("Running app as a module")}).call(t,n(36)(e))},function(e,t){e.exports=require("cluster")},function(e,t,n){"use strict";var r=process.env,o=n(1),i=o.promisifyAll(n(3)),s=n(2),c=function(e){try{i.accessSync(e,i.F_OK)}catch(e){return!1}return!0},u=function(e){if(c(e)){var t=i.readFileSync(e,"utf8");if(t){var n=JSON.parse(t);a(r,"",n)}}},a=function e(t,n,r){if(r instanceof Array)t[n]=r;else if(r instanceof Object)for(var o in r)e(t,n+o,r[o]);else t[n]=r};t.ENVSET=function(e,t){e&&(u(s.join(e,"project.json")),u(s.join(e,"db.json")),u(s.join(e,"cluster.json"))),t&&(u(s.join(t,"project.json")),u(s.join(t,"db.json")),u(s.join(t,"cluster.json"))),"production"===process.env.model&&(e&&(u(s.join(e,"production","project.json")),u(s.join(e,"production","db.json")),u(s.join(e,"production","cluster.json"))),t&&(u(s.join(t,"production","project.json")),u(s.join(t,"production","db.json")),u(s.join(t,"production","cluster.json"))))}},function(e,t,n){"use strict";var r=n(19);t.boot=function(e,t){r.ENVSET(e,t)}},function(e,t,n){"use strict";var r=n(22);t.boot=function(){r.set()}},function(e,t,n){"use strict";var r=n(2),o=process.env.name;o=o||"app";var i=r.join(process.cwd(),"logs",o),s={appenders:{STDOUT:{type:"stdout",layout:{type:"ENCODER_PATTERN",separator:","},filter:{level:"error"}},FILE:{type:"dateFile",filename:r.join(i,"common"),pattern:"_yyyy-MM-dd.log",compress:!0,alwaysIncludePattern:!0,layout:{type:"ENCODER_PATTERN",separator:","}},error:{type:"dateFile",filename:r.join(i,"error"),pattern:"_yyyy-MM-dd.log",compress:!0,alwaysIncludePattern:!0,levelFilter:{level:"error"},layout:{type:"ENCODER_PATTERN",separator:","}},ERROR_FILE:{type:"logLevelFilter",appender:"error",level:"error"}},categories:{default:{appenders:["STDOUT","FILE","ERROR_FILE"],level:"info"}}},c=n(48);t.set=function(){var e=n(0);e.addLayout("ENCODER_PATTERN",function(e){return function(e){return c(e.startTime).format("YYYY-MM-DD HH:MM:ss.SSS")+" [main] "+e.level.levelStr+" "+e.categoryName+" - "+e.data}}),e.configure(s)}},function(e,t,n){"use strict";var r=n(0),o=r.getLogger("ControllerApp"),i=n(50),s=n(40).exec,c=n(37),u=new Date,a=n(2),f=n(1),l=f.promisifyAll(n(3));t.status=function(e,t){o.info("Status Api Call");var n=e.app;if(e.query.info){var r={};c.parallel([function(e){s("netstat -an | grep :80 | wc -l",function(t,n){r[80]=parseInt(n,10),e()})},function(e){s("netstat -an | grep :"+n.set("port")+" | wc -l",function(t,o){r[n.set("port")]=parseInt(o,10),e()})}],function(e){t.json({status:"up",version:n.get("version"),sha:n.get("git sha"),started_at:u,node:{version:process.version,memory:Math.round(process.memoryUsage().rss/1024/1024)+"M",uptime:process.uptime()},system:{loadavg:i.loadavg(),freeMemory:Math.round(i.freemem()/1024/1024)+"M"},env:"production",hostname:i.hostname(),connections:r,swap:void 0})})}else t.json({status:"up"})};var p=n(7),d={code:0,data:p,model:process.env.model,PVersion:process.env.PVersion,state:process.env.state};t.listinfo=function(e,t){return t.status(200).json(d)};var y=function(e){return l.accessAsync(e,l.F_OK).then(function(e){return!0},function(e){return!1})},g=function(e){return l.readFileAsync(e,"utf8").then(function(e){if(e)return e})},v=function(e,t){var n=a.join(process.cwd(),"runtime","logs",e);y(n).then(function(e){return e?g(n).then(function(e){return e?t.status(200).json({code:0,data:e}):t.status(200).json({code:1})}):t.status(200).json({code:1})})};t.getLog=function(e,t){o.info("getLog api call"),e.query.filename?v(e.query.filename,t):v("latest.log",t)}},function(e,t,n){"use strict";var r=n(23),o=n(25),i=n(26);t.boot=function(e){e.get("/app/status",r.status),e.get("/app/listinfo",r.listinfo),e.get("/app/getLog",r.getLog),e.post("/order_notify",o.wxTinyPayNotify),e.post("/notify/ali/asyncpay",o.aliPayAsyncNotify),e.post("/notify/wx/asyncpay",o.wxPayAsyncNotify),e.get("/ok_notify/:out_trade_no",i.ok_notify)}},function(e,t,n){"use strict";var r=n(0),o=r.getLogger("ControllerPayNotify");t.wxTinyPayNotify=function(e,t){o.info("wxTinyPayNotify Api Call");var n=e.body;console.log(n),e.models.notify.WXTinyPaySuccess(n).then(function(e){return t.status(200).send(e)}).error(function(e){return t.status(200).send("<xml><return_code>FAIL</return_code><return_msg>支付通知失败</return_msg></xml>")})},t.aliPayAsyncNotify=function(e,t){return o.info("aliPayAsyncNotify Api Call"),e.body,t.status(200).json({code:0})},t.wxPayAsyncNotify=function(e,t){return o.info("wxPayAsyncNotify Api Call"),e.body,t.status(200).json({code:0})}},function(e,t,n){"use strict";var r=n(0),o=r.getLogger("ControllerSocketServer");t.ok_notify=function(e,t){o.info("ok_notify Api Call");var n=e.params.out_trade_no;if(!n)return t.status(200).json({code:1,msg:"参数错误-1"});e.models.notify.SaveAndNotifyOrder(n).then(function(e){return e?t.status(200).json(e):t.status(200).json({code:1,msg:"unknown-1"})}).error(function(e){return t.status(200).json({code:1,msg:"unknown-2"})})}},function(e,t,n){"use strict";t.boot=function(){n(28).boot(),n(6).boot()}},function(e,t,n){"use strict";var r=n(0),o=r.getLogger("MongoseIniter"),i=(n(1),n(5));i.Promise=n(1),t.boot=function(){var e=n(8).getParams(process.env.MongoUrl),t="mongodb://127.0.0.1:27017";e.host&&e.port&&(t="mongodb://"+e.host+":"+e.port);var r={useMongoClient:!0};i.connect(t+"/"+(e.db||"template"),r);var s=i.connection;s.on("error",function(e){o.error(e)}),s.once("open",function(){o.info("MongoDB open:"+e.db)})}},function(e,t,n){"use strict";var r=n(5),o=r.Schema,i=new o({_id:{type:String},openid:{trpe:String},type:{type:Number},num:{type:Number},date:{type:Date},fee:{type:String},platform:{type:String},name:{type:String},address:{type:String},stat:{type:Number}});t.deliver=r.model("deliver",i)},function(e,t,n){"use strict";function r(){var e=0;o.scheduleJob("*/1 * * * * *",function(){if(e+6e4<Date.now()){e=Date.now();var t=encodeURIComponent(process.env.Address),n=encodeURIComponent(process.env.name),r=encodeURIComponent(process.env.desc);c("http://"+process.env.Register+"/register/register?address="+t+"&name="+n+"&desc="+r,"GET",function(o,i,c,u){if(o||!i)return e=0,void s.error("Failure",o);var a="";try{a=JSON.parse(i)}catch(t){e=0,console.log(i)}o||!a||0==!a.code?(e=0,s.error("no register server at:http://"+process.env.Register+"/register/register?address="+t+"&name="+n+"&desc="+r)):s.info("register succeed at time:"+new Date)})}})}var o=n(49),i=n(0),s=i.getLogger("Task"),c=n(45);n(6),t.RegisterTask=function(){r()}},function(e,t,n){"use strict";var r=n(32),o={notify:r};t.boot=function(e){e.use(function(e,t,n){return e.models=o,n()})}},function(e,t,n){"use strict";var r=n(0),o=(r.getLogger("ServiceNotify"),n(1)),i=(n(4).deliver,n(4).deliver),s=n(6),c=n(12),u="<xml><return_code>FAIL</return_code><return_msg>支付通知失败</return_msg></xml>",a=process.env;t.WXTinyPaySuccess=function(e){var t=e.xml;if(t&&"SUCCESS"===t.return_code&&"SUCCESS"===t.result_code&&t.out_trade_no){var n=t.out_trade_no,r="dw:pre:order:"+n;return s.client().get(r).then(function(e){var t=JSON.parse(e);return t?(t.stat=2,new i(t).save().then(function(e){return e?(s.client().expire(r,0),s.client().del(r),c.NotifyServer(t).then(function(e){return e?"<xml><return_code>SUCCESS</return_code><return_msg>OK</return_msg></xml>":u})):u}).error(function(e){return u})):u}).catch(function(e){return u})}return new o(function(e){e(u)})};var f=n(11).AliPayUtils,l=a.alisellerid,p=a.aliappid;t.aliPayAsyncNotify=function(e){return new o(function(t){if(f.checkIsAliNotify(e)){var n=e.out_trade_no;if(!n)return void t("fail");var r="dw:pre:order:"+n;s.client().get(r).then(function(o){if(!o)return void i.find({_id:n}).then(function(e){t(e?"success":u)}).error(function(e){t(u)});var a=JSON.parse(o);return a?e.total_amount!==a.fee||e.out_trade_no!==a._id||e.seller_id!==l||e.app_id!==p?void t("fail"):(a.stat=2,void new i(a).save().then(function(e){if(e)return s.client().expire(r,0),s.client().del(r),c.NotifyServer(a).then(function(e){if(e)return void t("success");t("fail")});t("fail")}).error(function(e){t("fail")})):void t("fail")}).error(function(e){t("fail")})}else t("fail")})};var d=n(11).WxPayUtils;t.wxPayAsyncNotify=function(e){var t=e.xml;return new o(function(e){if(d.checkIsWxNotify(t)){var n=t.out_trade_no;if(!n)return void e(u);var r="dw:pre:order:"+n;s.client().get(r).then(function(o){if(!o)return void i.find({_id:n}).then(function(t){e(t?"success":u)}).error(function(t){e(u)});var a=JSON.parse(o);return a?t.total_fee!==a.fee||"SUCCESS"!==t.result_code?void e(u):(a.stat=2,void new i(a).save().then(function(t){if(t)return s.client().expire(r,0),s.client().del(r),c.NotifyServer(a).then(function(t){if(t)return void e("success");e("fail")});e("fail")}).error(function(t){e("fail")})):void e(u)}).catch(function(t){e(u)})}else e(u)})},t.SaveAndNotifyOrder=function(e){return i.findOneAndUpdate({_id:e},{stat:1}).then(function(e){return e?(e.stat=1,c.NotifyClient(e).then(function(e){return e?{code:0}:{code:1,msg:"处理出错001"}})):{code:1,msg:"无法查找订单数据"}}).error(function(e){return{code:1,msg:"数据库查询错误",err:e}})}},function(e,t,n){"use strict";function r(e,t){var n=c.createVerify("RSA-SHA1");return n.update(new Buffer(e,"utf-8")),n.verify(s,t,"base64")}function o(e){var t=Object.keys(e);t=t.sort();var n={};t.forEach(function(t){"sign"!=t&&"sign_type"!=t&&e[t]&&(n[t]=decodeURIComponent(e[t]))});var r="";for(var o in n)r+="&"+o+"="+n[o];return r=r.substr(1)}t.checkIsAliNotify=function(e){var t=e.sign;return r(o(e),t)};var i=process.env,s=i.alialipaypublickey;s=function(e,t,n){for(var r="",o=0;o<e.length;o+=64)r+=e.substring(o,o+64)+"\n";return r}(s),s="-----BEGIN PUBLIC KEY-----\n"+s+"-----END PUBLIC KEY-----\n";var c=n(14)},function(e,t,n){"use strict";function r(e){console.log("签名验证的参数",e);var t=o(e)+"&key="+s;return c.createHash("md5").update(t,"utf8").digest("hex").toUpperCase()}function o(e){var t=Object.keys(e);t=t.sort();var n={};t.forEach(function(t){"sign"!=t&&(n[t.toLowerCase()]=e[t])});var r="";for(var o in n)r+="&"+o+"="+n[o];return r=r.substr(1)}t.checkIsWxNotify=function(e){return e.sign===r(e)};var i=process.env,s=i.wxsecret,c=n(14)},function(e,t,n){"use strict";var r=n(0),o=r.getLogger("SocketIniter"),i=n(51).server,s=n(12);t.init=function(e){new i({httpServer:e,autoAcceptConnections:!0}).on("connect",function(e){o.info("connect"),e.on("message",function(t){if("utf8"===t.type)try{var n=JSON.parse(t.utf8Data),r=n.type;"slogin"===r?(o.info("slogin"),e.id=n.id,e.utype="server",s.AddServer(e),e.sendUTF(JSON.stringify({type:"ok_login"}))):"clogin"===r?(o.info("clogin"),e.id=n.id,e.utype="client",s.AddClient(e),e.sendUTF(JSON.stringify({type:"ok_login"}))):"ping"===r?(o.info("ping"),e.sendUTF(JSON.stringify({type:"ping",msg:"hb"}))):s.NotifyResponse(r,n.data)}catch(t){e.sendUTF(JSON.stringify({type:"err",msg:t}))}}).on("close",function(t,n){o.info("close"),"client"===e.utype?s.DelClient(e.id):s.DelServer(e.id)}).on("error",function(t){o.info("error"),"client"===e.utype?s.DelClient(e.id):s.DelServer(e.id)})})}},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){e.exports=require("async")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("body-parser-xml")},function(e,t){e.exports=require("child_process")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("errorhandler")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("httpinvoke")},function(e,t){e.exports=require("ioredis")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("node-schedule")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("websocket")}]);